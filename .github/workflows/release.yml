name: Release

on:
  workflow_dispatch:
    branches:
      - release
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·'
        required: true
        type: string
      prerelease:
        description: 'é¢„å‘å¸ƒç‰ˆæœ¬'
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always
  BINARY_NAME: fuxi-quant

jobs:
  build:
    name: æ„å»º ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            artifact_name: fuxi-quant
            asset_name: fuxi-quant-linux-x86_64
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            artifact_name: fuxi-quant.exe
            asset_name: fuxi-quant-windows-x86_64.exe
          - target: aarch64-apple-darwin
            os: macos-latest
            artifact_name: fuxi-quant
            asset_name: fuxi-quant-macos-arm64

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: é…ç½® Rust ç¼“å­˜
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: 'v1-rust'
          shared-key: ${{ matrix.target }}
          save-if: true

      - name: æ„å»º Release ç‰ˆæœ¬
        run: cargo build --release --target ${{ matrix.target }} -p fuxi-quant

      - name: å‡†å¤‡åˆ¶å“ (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          cp target/${{ matrix.target }}/release/${{ matrix.artifact_name }} ${{ matrix.asset_name }}
          chmod +x ${{ matrix.asset_name }}

      - name: å‡†å¤‡åˆ¶å“ (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          Copy-Item "target/${{ matrix.target }}/release/${{ matrix.artifact_name }}" "${{ matrix.asset_name }}"

      - name: ä¸Šä¼ æ„å»ºåˆ¶å“
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: ${{ matrix.asset_name }}
          retention-days: 7

  release:
    name: å‘å¸ƒåˆ° GitHub Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è·å–æ‰€æœ‰ Tags
        run: git fetch --tags --force

      - name: ä¸‹è½½æ‰€æœ‰åˆ¶å“
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: æ•´ç†åˆ¶å“æ–‡ä»¶
        run: |
          mkdir -p release
          find artifacts -type f -exec cp {} release/ \;
          ls -la release/

      - name: ç”Ÿæˆç‰ˆæœ¬å˜é‡
        id: version
        run: |
          VERSION="${{ inputs.version }}"
          echo "tag_name=${VERSION}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ª tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "é¦–æ¬¡å‘å¸ƒï¼Œæ— å†å²å˜æ›´è®°å½•"
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges -20)
          else
            echo "ä¸Šä¸€ä¸ªç‰ˆæœ¬: $PREVIOUS_TAG"
            COMMITS=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          # ä½¿ç”¨ EOF å†™å…¥å¤šè¡Œå†…å®¹
          {
            echo 'changelog<<EOF'
            echo "## âœ¨ æ›´æ–°å†…å®¹"
            echo ""
            if [ -n "$COMMITS" ]; then
              echo "$COMMITS"
            else
              echo "ğŸ‰ é¦–æ¬¡å‘å¸ƒ"
            fi
            echo ""
            echo "---"
            echo ""
            if [ -n "$PREVIOUS_TAG" ]; then
              echo "ğŸ“‹ [æŸ¥çœ‹å®Œæ•´å˜æ›´è®°å½•](https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG}...${{ steps.version.outputs.tag_name }})"
            fi
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: åˆ›å»º Tag å’Œ Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          name: ${{ steps.version.outputs.tag_name }}
          body: ${{ steps.changelog.outputs.changelog }}
          files: release/*
          draft: false
          prerelease: ${{ inputs.prerelease }}
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: å‘é€å‘å¸ƒé‚®ä»¶é€šçŸ¥
        if: always()
        uses: ./.github/actions/send-email
        with:
          status: ${{ job.status }}
          type: 'release'
          version: '${{ steps.version.outputs.tag_name }}'
          mail_username: ${{ secrets.MAIL_USERNAME }}
          mail_password: ${{ secrets.MAIL_PASSWORD }}
          mail_to: ${{ secrets.MAIL_TO }}
